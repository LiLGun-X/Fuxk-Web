#!/bin/bash

# ========== CONFIG ==========
WEBROOT="/var/www/m3u8proxy"
PORT=6969
PHP_SOCKET="unix:/var/run/php/php$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')-fpm.sock"
# ============================

echo "?? ติดตั้ง NGINX และ PHP..."
sudo apt update
sudo apt install -y nginx php php-fpm php-curl

echo "?? สร้างโฟลเดอร์เว็บที่ $WEBROOT"
sudo mkdir -p "$WEBROOT"
sudo chown -R $USER:$USER "$WEBROOT"

echo "?? สร้าง index.php..."
cat > "$WEBROOT/index.php" <<'EOF'
<?php
function e($s) {
    return htmlspecialchars($s, ENT_QUOTES, 'UTF-8');
}

$m3u8 = $_POST['m3u8'] ?? '';
$referer = $_POST['referer'] ?? '';
$generatedLink = '';

if ($m3u8 && $referer) {
    $encodedUrl = urlencode($m3u8);
    $encodedReferer = urlencode($referer);
    $generatedLink = "http://{$_SERVER['HTTP_HOST']}/stream.php?url=$encodedUrl&referer=$encodedReferer";
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>M3U8 Proxy Generator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input[type="text"] { width: 100%; padding: 8px; margin: 6px 0; }
    button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; }
    .output { margin-top: 20px; padding: 10px; background: #f8f9fa; border: 1px solid #ccc; position: relative; }
    .copy-button { margin-top: 10px; background-color: #28a745; }
    .copied { color: green; margin-left: 10px; }
  </style>
</head>
<body>
  <h2>M3U8 Proxy Link Generator</h2>
  <form method="post">
    <label>M3U8 URL:</label>
    <input type="text" name="m3u8" required value="<?= e($m3u8) ?>">

    <label>Referer:</label>
    <input type="text" name="referer" required value="<?= e($referer) ?>">

    <button type="submit">Generate Proxy Link</button>
  </form>

  <?php if ($generatedLink): ?>
    <div class="output">
      <strong>Proxy Link:</strong><br>
      <input type="text" id="proxyLink" value="<?= e($generatedLink) ?>" readonly style="width:100%; padding:5px;">
      <button class="copy-button" onclick="copyLink()">Copy</button>
      <span class="copied" id="copiedMsg" style="display:none;">Copied!</span>
    </div>
  <?php endif; ?>

  <script>
    function copyLink() {
      const linkInput = document.getElementById('proxyLink');
      linkInput.select();
      linkInput.setSelectionRange(0, 99999);
      document.execCommand("copy");

      const msg = document.getElementById('copiedMsg');
      msg.style.display = 'inline';
      setTimeout(() => {
        msg.style.display = 'none';
      }, 2000);
    }
  </script>
</body>
</html>
EOF

echo "?? สร้าง stream.php..."
cat > "$WEBROOT/stream.php" <<'EOF'
<?php
$url = $_GET['url'] ?? '';
if (!$url || !filter_var($url, FILTER_VALIDATE_URL)) {
    http_response_code(400);
    exit('Invalid URL');
}

$referer = $_GET['referer'] ?? 'https://example.com';
$userAgent = $_GET['ua'] ?? 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)';

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    "Referer: $referer",
    "User-Agent: $userAgent"
]);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
$data = curl_exec($ch);
$info = curl_getinfo($ch);
curl_close($ch);

if (strpos($info['content_type'], 'application/vnd.apple.mpegurl') !== false || strpos($url, '.m3u8') !== false) {
    header('Content-Type: application/vnd.apple.mpegurl');
} else {
    header('Content-Type: text/plain');
}

echo $data;
EOF

echo "?? ตั้งค่า NGINX สำหรับพอร์ต $PORT..."
NGINX_CONF="/etc/nginx/sites-available/m3u8proxy"
sudo tee "$NGINX_CONF" > /dev/null <<EOF
server {
    listen $PORT;
    server_name _;

    root $WEBROOT;
    index index.php index.html;

    location / {
        try_files \$uri \$uri/ =404;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass $PHP_SOCKET;
    }
}
EOF

echo "?? เปิดใช้งาน config..."
sudo ln -sf "$NGINX_CONF" /etc/nginx/sites-enabled/

echo "?? รีโหลด NGINX..."
sudo nginx -t && sudo systemctl reload nginx

echo "✅ เสร็จแล้ว! เข้าดูที่: http://<your-server-ip>:$PORT"
